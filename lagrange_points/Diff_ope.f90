module Diff_ope
    

    !MODULO CON EL OPERADOR DIFERENCIAL ADAPTADO A LAS INTERFACES
    
    contains
    
    
    
    function F(xv) !Adaptado para la subrutina NEWTON
    
    
        real, intent(in) :: xv(:)
        real :: F(size(xv))
        real :: mu
        
        mu = 1/((5.972E24+7.349E22)/7.349E22)
        
        F(4) = xv(4)
        F(5) = xv(5)
        F(6) = xv(6)
        F(1) = xv(1) + 2*xv(5) - ((1-mu)*(xv(1)+mu))/(sqrt((xv(1)+mu)**2 + xv(2)**2+xv(3)**2))**3 - mu*(xv(1)-1+mu)/((xv(1)-1+mu)**2+xv(2)**2+xv(3)**2)**(3./2.)
        F(2) = xv(2) - 2*xv(4) - (1-mu)*xv(2)/(sqrt((xv(1)+mu)**2+xv(2)**2 + xv(3)**2))**3-mu*xv(2)/((xv(1)-1+mu)**2+xv(2)**2+xv(3)**2)**(3./2.)
        F(3) = -(1-mu)*xv(3)/(sqrt((xv(1)+mu)**2 + xv(2)**2+xv(3)**2))**3 - mu*xv(3)/((xv(1)-1+mu)**2+xv(2)**2+xv(3)**2)**(3./2.)
        
        
    end function
    
     
    
    function F_linear(xv,t) !Adaptado para la subrutina SYSTEM_MATRIX
    
    
        real :: xv(:), t
        real :: F_linear(size(xv))
        real :: mu
        
        mu = 1/((5.972E24+7.349E22)/7.349E22)
        
        F_linear(1) = xv(4)
        F_linear(2) = xv(5)
        F_linear(3) = xv(6)
        F_linear(4) = xv(1) + 2*xv(5) - ((1-mu)*(xv(1)+mu))/(sqrt((xv(1)+mu)**2 + xv(2)**2+xv(3)**2))**3 - mu*(xv(1)-1+mu)/((xv(1)-1+mu)**2+xv(2)**2+xv(3)**2)**(3./2.)
        F_linear(5) = xv(2) - 2*xv(4) - (1-mu)*xv(2)/(sqrt((xv(1)+mu)**2+xv(2)**2 + xv(3)**2))**3-mu*xv(2)/((xv(1)-1+mu)**2+xv(2)**2+xv(3)**2)**(3./2.)
        F_linear(6) = -(1-mu)*xv(3)/(sqrt((xv(1)+mu)**2 + xv(2)**2+xv(3)**2))**3 - mu*xv(3)/((xv(1)-1+mu)**2+xv(2)**2+xv(3)**2)**(3./2.)
        
    end function
    
    
    
    
    
    subroutine F_prop(N,x,xv,F,RPAR,IPAR) !Adaptado para las subrutinas DOP853 Y ODEX
    real :: x,xv(N),F(N),RPAR
    INTEGER IPAR,N
        real :: mu
    
    
        mu = 1/((5.972E24+7.349E22)/7.349E22)
        
        F(1) = xv(4)
        F(2) = xv(5)
        F(3) = xv(6)
        F(4) = xv(1) + 2*xv(5) - ((1-mu)*(xv(1)+mu))/(sqrt((xv(1)+mu)**2 + xv(2)**2+xv(3)**2))**3 - mu*(xv(1)-1+mu)/((xv(1)-1+mu)**2+xv(2)**2+xv(3)**2)**(3./2.)
        F(5) = xv(2) - 2*xv(4) - (1-mu)*xv(2)/(sqrt((xv(1)+mu)**2+xv(2)**2 + xv(3)**2))**3-mu*xv(2)/((xv(1)-1+mu)**2+xv(2)**2+xv(3)**2)**(3./2.)
        F(6) = -(1-mu)*xv(3)/(sqrt((xv(1)+mu)**2 + xv(2)**2+xv(3)**2))**3 - mu*xv(3)/((xv(1)-1+mu)**2+xv(2)**2+xv(3)**2)**(3./2.)
    
    
    
    end subroutine
    
    
    
    
    
    
    
    
    subroutine F_lin(N,x,xv,F,RPAR,IPAR) !Problema lineal adaptado para las subrutinas DOP853 Y ODEX
    DOUBLE PRECISION x,xv(N),F(N),RPAR
    INTEGER IPAR,N
    real :: A4(6,6), A1(6,6), w(6)
    
    w = xv - [ 0.487843830690319,       0.866025403784437,       0.000000000000000E+000, &
               0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000]
    
    A1(1,:) =  [ 0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000, &
                 1.00000000000000,       0.000000000000000E+000,  0.000000000000000E+000 ]
    A1(2,:) =  [  0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000, &
                  0.000000000000000E+000,   1.00000000000000,       0.000000000000000E+000 ]
    A1(3,:) =  [  0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000, &
                  0.000000000000000E+000,  0.000000000000000E+000,   1.00000000000000 ]
    A1(4,:) =  [ 11.3607533778901,      -3.226100799424980E-002, -3.226100799424980E-002, &
                 0.000000000000000E+000,   2.00000000000000,       0.000000000000000E+000 ]
    A1(5,:) =  [ 0.000000000000000E+000,  -4.14756059103548,       0.000000000000000E+000, &
                -2.00000000000000,       0.000000000000000E+000,  0.000000000000000E+000 ]
    A1(6,:) =  [ 0.000000000000000E+000,  0.000000000000000E+000,  -5.14756059103548, &
                 0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000 ]
    
    
    
    A4(1,:) =  [  0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000, &
                 1.00000000000000,       0.000000000000000E+000,  0.000000000000000E+000]
    A4(2,:) =  [  0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000, &
                 0.000000000000000E+000,   1.00000000000000,       0.000000000000000E+000]
    A4(3,:) =  [  0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000, &
                 0.000000000000000E+000,  0.000000000000000E+000,   1.00000000000000 ]
    A4(4,:) =  [  0.751279433369058,        1.26544546993549,       7.317648314268330E-004, &
                 0.000000000000000E+000,   2.00000000000000,       0.000000000000000E+000 ]
    A4(5,:) =  [ 1.26712937350702,        2.24902581628524,       1.299036482093133E-003, &
                -2.00000000000000,       0.000000000000000E+000,  0.000000000000000E+000 ]
    A4(6,:) =  [ 0.000000000000000E+000,  0.000000000000000E+000, -0.999998500001875, &
                 0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000 ]
    
    
    F = matmul(A4,w)
    
    
    
    end subroutine
    
    
    
    subroutine F_prop_ODE(x,xv,F) !Adaptado para las subrutina ODE
    DOUBLE PRECISION x,xv(6),F(6)
        real :: mu
    
    
        mu = 1/((5.972E24+7.349E22)/7.349E22)
        
        F(1) = xv(4)
        F(2) = xv(5)
        F(3) = xv(6)
        F(4) = xv(1) + 2*xv(5) - ((1-mu)*(xv(1)+mu))/(sqrt((xv(1)+mu)**2 + xv(2)**2+xv(3)**2))**3 - mu*(xv(1)-1+mu)/((xv(1)-1+mu)**2+xv(2)**2+xv(3)**2)**(3./2.)
        F(5) = xv(2) - 2*xv(4) - (1-mu)*xv(2)/(sqrt((xv(1)+mu)**2+xv(2)**2 + xv(3)**2))**3-mu*xv(2)/((xv(1)-1+mu)**2+xv(2)**2+xv(3)**2)**(3./2.)
        F(6) = -(1-mu)*xv(3)/(sqrt((xv(1)+mu)**2 + xv(2)**2+xv(3)**2))**3 - mu*xv(3)/((xv(1)-1+mu)**2+xv(2)**2+xv(3)**2)**(3./2.)
    
    
    
    end subroutine
    
    
    
    
    subroutine F_lin_ode(x,xv,F)  !Problema lineal adaptado para las subrutina ODE
    DOUBLE PRECISION x,xv(6),F(6)
    real :: A4(6,6), A1(6,6), w(6)
    
    w = xv - [ 0.487843830690319,       0.866025403784437,       0.000000000000000E+000, &
               0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000]
    
    
    A1(1,:) =  [ 0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000, &
                 1.00000000000000,       0.000000000000000E+000,  0.000000000000000E+000 ]
    A1(2,:) =  [  0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000, &
                  0.000000000000000E+000,   1.00000000000000,       0.000000000000000E+000 ]
    A1(3,:) =  [  0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000, &
                  0.000000000000000E+000,  0.000000000000000E+000,   1.00000000000000 ]
    A1(4,:) =  [ 11.3607533778901,      -3.226100799424980E-002, -3.226100799424980E-002, &
                 0.000000000000000E+000,   2.00000000000000,       0.000000000000000E+000 ]
    A1(5,:) =  [ 0.000000000000000E+000,  -4.14756059103548,       0.000000000000000E+000, &
                -2.00000000000000,       0.000000000000000E+000,  0.000000000000000E+000 ]
    A1(6,:) =  [ 0.000000000000000E+000,  0.000000000000000E+000,  -5.14756059103548, &
                 0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000 ]
    
    
    
    A4(1,:) =  [  0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000, &
                 1.00000000000000,       0.000000000000000E+000,  0.000000000000000E+000]
    A4(2,:) =  [  0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000, &
                 0.000000000000000E+000,   1.00000000000000,       0.000000000000000E+000]
    A4(3,:) =  [  0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000, &
                 0.000000000000000E+000,  0.000000000000000E+000,   1.00000000000000 ]
    A4(4,:) =  [  0.751279433369058,        1.26544546993549,       7.317648314268330E-004, &
                 0.000000000000000E+000,   2.00000000000000,       0.000000000000000E+000 ]
    A4(5,:) =  [ 1.26712937350702,        2.24902581628524,       1.299036482093133E-003, &
                -2.00000000000000,       0.000000000000000E+000,  0.000000000000000E+000 ]
    A4(6,:) =  [ 0.000000000000000E+000,  0.000000000000000E+000, -0.999998500001875, &
                 0.000000000000000E+000,  0.000000000000000E+000,  0.000000000000000E+000 ]
    
    
    F = matmul(A4,w)
    
    
    
    
    
    
    end subroutine
    
    
    
    
    
    
end module
    